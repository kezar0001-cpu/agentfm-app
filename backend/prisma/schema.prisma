generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                      String                  @id @default(cuid())
  email                   String                  @unique
  passwordHash            String
  firstName               String
  lastName                String
  phone                   String?
  role                    Role
  isActive                Boolean                 @default(true)
  lastLoginAt             DateTime?
  createdAt               DateTime                @default(now())
  updatedAt               DateTime                @updatedAt
  orgId                   String?
  company                 String?
  subscriptionPlan        SubscriptionPlan        @default(FREE_TRIAL)
  subscriptionStatus      SubscriptionStatus      @default(TRIAL)
  trialEndDate            DateTime?
  emailVerified           Boolean                 @default(false)
  assignedInspections     Inspection[]            @relation("AssignedTechnician")
  completedInspections    Inspection[]            @relation("CompletedBy")
  inspectionAuditLogs     InspectionAuditLog[]
  inspectionReminders     InspectionReminder[]
  uploadedAttachments     InspectionAttachment[] @relation("InspectionAttachmentUploadedBy")
  sentInvites             Invite[]                @relation("InvitedBy")
  receivedInvite          Invite?                 @relation("InvitedUser")
  assignedJobs            Job[]                   @relation("AssignedTechnician")
  createdJobs             Job[]                   @relation("CreatedJobs")
  jobComments             JobComment[]
  notifications           Notification[]
  OwnerProfile            OwnerProfile?
  managedProperties       Property[]              @relation("PropertyManager")
  PropertyManagerProfile  PropertyManagerProfile?
  ownedProperties         PropertyOwner[]
  approvedRecommendations Recommendation[]        @relation("ApprovedBy")
  createdRecommendations  Recommendation[]        @relation("CreatedBy")
  requestedServiceRequests ServiceRequest[]       @relation("RequestedBy")
  approvedServiceRequests  ServiceRequest[]       @relation("ApprovedRequests")
  rejectedServiceRequests  ServiceRequest[]       @relation("RejectedRequests")
  reviewedServiceRequests  ServiceRequest[]       @relation("ReviewedRequests")
  subscriptions           Subscription[]
  TechnicianProfile       TechnicianProfile?
  TenantProfile           TenantProfile?
  tenantUnits             UnitTenant[]
  reportRequests          ReportRequest[]         @relation("ReportRequestsCreated")
  passwordResets          PasswordReset[]
  auditLogs               AuditLog[]
  Org                     Org?                    @relation(fields: [orgId], references: [id])
  uploadedPropertyImages  PropertyImage[]         @relation("PropertyImageUploader")
  uploadedPropertyDocs    PropertyDocument[]      @relation("PropertyDocumentUploader")
  propertyNotes           PropertyNote[]

  @@index([email])
  @@index([role])
}

model PasswordReset {
  id        String   @id @default(cuid())
  userId    String
  selector  String   @unique
  verifier  String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([selector])
}

model Invite {
  id            String       @id @default(cuid())
  email         String
  role          Role
  token         String       @unique
  status        InviteStatus @default(PENDING)
  expiresAt     DateTime
  createdAt     DateTime     @default(now())
  invitedById   String
  invitedUserId String?      @unique
  propertyId    String?
  unitId        String?
  invitedBy     User         @relation("InvitedBy", fields: [invitedById], references: [id], onDelete: Cascade)
  invitedUser   User?        @relation("InvitedUser", fields: [invitedUserId], references: [id])
  property      Property?    @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  unit          Unit?        @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([token])
  @@index([status])
}

model Subscription {
  id                     String             @id @default(cuid())
  userId                 String
  planId                 String
  planName               String
  status                 SubscriptionStatus @default(TRIAL)
  stripeCustomerId       String?            @unique
  stripeSubscriptionId   String?            @unique
  stripeCurrentPeriodEnd DateTime?
  trialStartDate         DateTime           @default(now())
  trialEndDate           DateTime?
  startDate              DateTime           @default(now())
  endDate                DateTime?
  cancelledAt            DateTime?
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  user                   User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
}

model Property {
  id              String            @id @default(cuid())
  name            String
  address         String
  city            String
  state           String
  zipCode         String
  country         String            @default("USA")
  propertyType    String
  yearBuilt       Int?
  totalUnits      Int               @default(0)
  totalArea       Float?
  status          PropertyStatus    @default(ACTIVE)
  description     String?
  imageUrl        String?

  // Enhanced property details
  lotSize              Float?
  buildingSize         Float?
  numberOfFloors       Int?
  constructionType     String?
  heatingSystem        String?
  coolingSystem        String?

  // Amenities and features (stored as JSON)
  amenities            Json?

  // Financial information (PM/Owner access only)
  purchasePrice        Float?
  purchaseDate         DateTime?
  currentMarketValue   Float?
  annualPropertyTax    Float?
  annualInsurance      Float?
  monthlyHOA           Float?

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  managerId       String

  // Relations
  inspections     Inspection[]
  invites         Invite[]
  jobs            Job[]
  plans           MaintenancePlan[]
  manager         User              @relation("PropertyManager", fields: [managerId], references: [id], onDelete: Cascade)
  owners          PropertyOwner[]
  reportRequests  ReportRequest[]
  serviceRequests ServiceRequest[]
  units           Unit[]
  images          PropertyImage[]
  documents       PropertyDocument[]
  notes           PropertyNote[]

  @@index([managerId])
  @@index([status])
  @@index([city, state])
}

model PropertyOwner {
  id                  String    @id @default(cuid())
  propertyId          String
  ownerId             String
  ownershipPercentage Float     @default(100.0)
  startDate           DateTime  @default(now())
  endDate             DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  owner               User      @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  property            Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@unique([propertyId, ownerId])
  @@index([propertyId])
  @@index([ownerId])
}

model PropertyImage {
  id            String   @id @default(cuid())
  propertyId    String
  imageUrl      String
  caption       String?
  displayOrder  Int      @default(0)
  isPrimary     Boolean  @default(false)
  uploadedAt    DateTime @default(now())
  uploadedBy    String

  property      Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  uploader      User     @relation("PropertyImageUploader", fields: [uploadedBy], references: [id])

  @@index([propertyId])
  @@index([isPrimary])
  @@index([displayOrder])
}

model PropertyDocument {
  id            String                  @id @default(cuid())
  propertyId    String
  fileName      String
  fileUrl       String
  fileSize      Int
  mimeType      String
  category      DocumentCategory
  description   String?
  accessLevel   DocumentAccessLevel     @default(PROPERTY_MANAGER)
  uploadedAt    DateTime                @default(now())
  uploadedBy    String

  property      Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  uploader      User     @relation("PropertyDocumentUploader", fields: [uploadedBy], references: [id])

  @@index([propertyId])
  @@index([category])
  @@index([accessLevel])
}

model PropertyNote {
  id            String   @id @default(cuid())
  propertyId    String
  userId        String
  content       String   @db.Text
  isPrivate     Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  property      Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  user          User     @relation(fields: [userId], references: [id])

  @@index([propertyId])
  @@index([userId])
  @@index([createdAt])
}

model Unit {
  id              String           @id @default(cuid())
  unitNumber      String
  propertyId      String
  floor           Int?
  bedrooms        Int?
  bathrooms       Float?
  area            Float?
  rentAmount      Float?
  status          UnitStatus       @default(AVAILABLE)
  description     String?
  imageUrl        String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  inspections     Inspection[]
  invites         Invite[]
  jobs            Job[]
  reportRequests  ReportRequest[]
  serviceRequests ServiceRequest[]
  property        Property         @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  tenants         UnitTenant[]

  @@unique([propertyId, unitNumber])
  @@index([propertyId])
  @@index([status])
}

model UnitTenant {
  id            String   @id @default(cuid())
  unitId        String
  tenantId      String
  leaseStart    DateTime
  leaseEnd      DateTime
  rentAmount    Float
  depositAmount Float?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  tenant        User     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  unit          Unit     @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@index([unitId])
  @@index([tenantId])
  @@index([isActive])
}

model Inspection {
  id              String            @id @default(cuid())
  title           String
  type            InspectionType
  scheduledDate   DateTime
  completedDate   DateTime?
  propertyId      String
  unitId          String?
  assignedToId    String?
  completedById   String?
  status          InspectionStatus  @default(SCHEDULED)
  notes           String?
  findings        String?
  tags            String[]          @default([])
  photos          String[]          @default([])
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  assignedTo      User?             @relation("AssignedTechnician", fields: [assignedToId], references: [id])
  completedBy     User?             @relation("CompletedBy", fields: [completedById], references: [id])
  property        Property          @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  unit            Unit?             @relation(fields: [unitId], references: [id], onDelete: Cascade)
  attachments     InspectionAttachment[]
  auditLogs       InspectionAuditLog[]
  reminders       InspectionReminder[]
  jobs            Job[]
  report          Report?

  @@index([propertyId])
  @@index([unitId])
  @@index([assignedToId])
  @@index([status])
  @@index([scheduledDate])
}

model Job {
  id                String           @id @default(cuid())
  title             String
  description       String
  priority          JobPriority      @default(MEDIUM)
  status            JobStatus        @default(OPEN)
  propertyId        String?
  unitId            String?
  assignedToId      String?
  createdById       String
  serviceRequestId  String?
  maintenancePlanId String?
  inspectionId      String?
  scheduledDate     DateTime?
  startedAt         DateTime?
  completedDate     DateTime?
  estimatedCost     Float?
  actualCost        Float?
  evidence          Json?
  notes             String?
  technicianNotes   String?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  createdBy         User             @relation("CreatedJobs", fields: [createdById], references: [id])
  assignedTo        User?            @relation("AssignedTechnician", fields: [assignedToId], references: [id])
  Inspection        Inspection?      @relation(fields: [inspectionId], references: [id])
  maintenancePlan   MaintenancePlan? @relation(fields: [maintenancePlanId], references: [id])
  property          Property?        @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  serviceRequest    ServiceRequest?  @relation(fields: [serviceRequestId], references: [id])
  unit              Unit?            @relation(fields: [unitId], references: [id], onDelete: Cascade)
  comments          JobComment[]

  @@index([propertyId])
  @@index([unitId])
  @@index([assignedToId])
  @@index([createdById])
  @@index([status])
  @@index([priority])
  @@index([scheduledDate])
  @@index([inspectionId])
}

model MaintenancePlan {
  id                String    @id @default(cuid())
  name              String
  description       String?
  propertyId        String
  frequency         String
  nextDueDate       DateTime
  lastCompletedDate DateTime?
  autoCreateJobs    Boolean   @default(false)
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  jobs              Job[]
  property          Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)

  @@index([propertyId])
  @@index([isActive])
  @@index([nextDueDate])
}

model ServiceRequest {
  id                     String                 @id @default(cuid())
  title                  String
  description            String
  category               ServiceRequestCategory
  priority               JobPriority            @default(MEDIUM)
  status                 ServiceRequestStatus   @default(SUBMITTED)
  propertyId             String
  unitId                 String?
  requestedById          String
  photos                 String[]               @default([])
  reviewNotes            String?
  reviewedAt             DateTime?

  // New fields for budget and approval workflow
  ownerEstimatedBudget   Float?
  managerEstimatedCost   Float?
  approvedBudget         Float?
  costBreakdownNotes     String?

  approvedById           String?
  approvedAt             DateTime?
  rejectedById           String?
  rejectedAt             DateTime?
  rejectionReason        String?

  lastReviewedById       String?
  lastReviewedAt         DateTime?

  createdAt              DateTime               @default(now())
  updatedAt              DateTime               @updatedAt

  jobs                   Job[]
  property               Property               @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  requestedBy            User                   @relation("RequestedBy", fields: [requestedById], references: [id], onDelete: Cascade)
  approvedBy             User?                  @relation("ApprovedRequests", fields: [approvedById], references: [id])
  rejectedBy             User?                  @relation("RejectedRequests", fields: [rejectedById], references: [id])
  lastReviewedBy         User?                  @relation("ReviewedRequests", fields: [lastReviewedById], references: [id])
  unit                   Unit?                  @relation(fields: [unitId], references: [id])

  @@index([propertyId])
  @@index([unitId])
  @@index([requestedById])
  @@index([approvedById])
  @@index([rejectedById])
  @@index([status])
  @@index([category])
}

model Report {
  id              String           @id @default(cuid())
  title           String
  inspectionId    String           @unique
  summary         String
  findings        String
  pdfUrl          String?
  data            Json?
  generatedDate   DateTime         @default(now())
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  recommendations Recommendation[]
  inspection      Inspection       @relation(fields: [inspectionId], references: [id], onDelete: Cascade)

  @@index([inspectionId])
  @@index([generatedDate])
}

model ReportRequest {
  id              String   @id @default(cuid())
  reportType      String
  parameters      Json?
  propertyId      String
  unitId          String?
  requestedById   String
  status          String   @default("PENDING")
  fileUrl         String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  property        Property @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  unit            Unit?    @relation(fields: [unitId], references: [id])
  requestedBy     User     @relation("ReportRequestsCreated", fields: [requestedById], references: [id])
  
  @@index([propertyId])
  @@index([unitId])
  @@index([requestedById])
  @@index([status])
}

model Recommendation {
  id              String               @id @default(cuid())
  title           String
  description     String
  reportId        String
  estimatedCost   Float?
  priority        JobPriority          @default(MEDIUM)
  status          RecommendationStatus @default(DRAFT)
  createdById     String
  approvedById    String?
  approvedAt      DateTime?
  implementedAt   DateTime?
  rejectionReason String?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  approvedBy      User?                @relation("ApprovedBy", fields: [approvedById], references: [id])
  createdBy       User                 @relation("CreatedBy", fields: [createdById], references: [id], onDelete: Cascade)
  report          Report               @relation(fields: [reportId], references: [id], onDelete: Cascade)

  @@index([reportId])
  @@index([status])
  @@index([createdById])
}

model Notification {
  id         String           @id @default(cuid())
  userId     String
  type       NotificationType
  title      String
  message    String
  isRead     Boolean          @default(false)
  readAt     DateTime?
  entityType String?
  entityId   String?
  createdAt  DateTime         @default(now())
  user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}

model InspectionAttachment {
  id            String      @id @default(cuid())
  inspectionId  String
  name          String      @map("fileName")
  mimeType      String      @map("fileType")
  url           String      @map("fileUrl")
  size          Int?
  annotations   Json?
  uploadedById  String?
  createdAt     DateTime    @default(now()) @map("uploadedAt")
  inspection    Inspection  @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  uploadedBy    User?       @relation("InspectionAttachmentUploadedBy", fields: [uploadedById], references: [id])

  @@index([inspectionId])
}

model InspectionAuditLog {
  id           String     @id @default(cuid())
  action       String
  changes      Json?
  createdAt    DateTime   @default(now()) @map("timestamp")
  inspectionId String
  userId       String?
  inspection   Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  user         User?      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([inspectionId])
  @@index([createdAt])
  @@index([userId])
}

model InspectionReminder {
  id           String     @id @default(cuid())
  inspectionId String
  remindAt     DateTime   @map("reminderDate")
  sentAt       DateTime?
  channel      String
  recipients   String[]   @default([])
  metadata     Json?
  createdById  String     @map("userId")
  inspection   Inspection @relation(fields: [inspectionId], references: [id], onDelete: Cascade)
  createdBy    User       @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([inspectionId])
  @@index([remindAt])
  @@index([createdById])
}

model Org {
  id        String   @id
  name      String
  createdAt DateTime @default(now())
  User      User[]
}

model OwnerProfile {
  id     String @id
  userId String @unique
  User   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model PropertyManagerProfile {
  id                String   @id
  userId            String   @unique
  managedProperties Json?
  permissions       Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime
  User              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model TechnicianProfile {
  id     String @id
  userId String @unique
  User   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model TenantProfile {
  id     String @id
  userId String @unique
  User   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum Role {
  PROPERTY_MANAGER
  OWNER
  TENANT
  TECHNICIAN
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PENDING
  SUSPENDED
  CANCELLED
}

enum PropertyStatus {
  ACTIVE
  INACTIVE
  FOR_SALE
  FOR_RENT
  UNDER_CONTRACT
  SOLD
  RENTED
  UNDER_RENOVATION
  UNDER_MAINTENANCE
}

enum UnitStatus {
  AVAILABLE
  OCCUPIED
  MAINTENANCE
  VACANT
  PENDING_MOVE_IN
  PENDING_MOVE_OUT
}

enum InviteStatus {
  PENDING
  ACCEPTED
  EXPIRED
}

enum InspectionStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum InspectionType {
  ROUTINE
  MOVE_IN
  MOVE_OUT
  EMERGENCY
  COMPLIANCE
}

enum JobStatus {
  OPEN
  ASSIGNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum JobPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum ServiceRequestStatus {
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  CONVERTED_TO_JOB
  REJECTED
  COMPLETED
  PENDING_MANAGER_REVIEW
  PENDING_OWNER_APPROVAL
  APPROVED_BY_OWNER
  REJECTED_BY_OWNER
}

enum ServiceRequestCategory {
  PLUMBING
  ELECTRICAL
  HVAC
  APPLIANCE
  STRUCTURAL
  PEST_CONTROL
  LANDSCAPING
  GENERAL
  OTHER
}

enum RecommendationStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  APPROVED
  REJECTED
  IMPLEMENTED
}

enum NotificationType {
  INSPECTION_SCHEDULED
  INSPECTION_REMINDER
  JOB_ASSIGNED
  JOB_COMPLETED
  SERVICE_REQUEST_UPDATE
  SUBSCRIPTION_EXPIRING
  PAYMENT_DUE
  SYSTEM
}

enum SubscriptionPlan {
  FREE_TRIAL
  STARTER
  PROFESSIONAL
  ENTERPRISE
}

model JobComment {
  id        String   @id @default(cuid())
  jobId     String
  userId    String
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  job       Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id])

  @@index([jobId])
  @@index([userId])
  @@index([createdAt])
}

model AuditLog {
  id         String   @id @default(cuid())
  entityType String
  entityId   String
  action     String
  userId     String
  changes    Json?
  metadata   Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([entityType, entityId])
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

enum DocumentCategory {
  LEASE
  INSURANCE
  CERTIFICATE
  INSPECTION
  TAX_DOCUMENT
  WARRANTY
  MAINTENANCE
  DEED
  MORTGAGE
  APPRAISAL
  OTHER
}

enum DocumentAccessLevel {
  PUBLIC
  TENANT
  OWNER
  PROPERTY_MANAGER
}
