# render.yaml â€” AgentFM (backend + frontend)

services:
  # -----------------------------
  # Backend (Express + Prisma)
  # -----------------------------
  - type: web
    name: agentfm-backend
    runtime: node                  # was `env: node`; `runtime` is preferred
    rootDir: backend
    plan: free
    buildCommand: npm ci && npx prisma generate
    preDeployCommand: npx prisma migrate deploy   # run migrations pre-deploy
    startCommand: node src/index.js
    healthCheckPath: /health                     # use healthCheckPath (spec)
    envVars:
      - key: DATABASE_URL
        sync: false
      - key: JWT_SECRET
        generateValue: true
      - key: SESSION_SECRET
        generateValue: true
      - key: FRONTEND_URL
        fromService:
          type: web
          name: agentfm-frontend
          property: url
      - key: NODE_ENV
        value: production

  # -----------------------------
  # Frontend (Vite static site)
  # -----------------------------
  - type: web
    name: agentfm-frontend
    runtime: static               # <-- this is what makes it a static site
    rootDir: frontend
    buildCommand: npm ci && npm run build
    staticPublishPath: dist
    routes:                       # Static-site rewrites/proxies are supported
      - type: rewrite
        source: /api/*
        destination: https://agentfm-backend.onrender.com/api/*
      - type: rewrite
        source: /*
        destination: /index.html
    envVars:
      - key: VITE_API_BASE_URL
        fromService:
          type: web
          name: agentfm-backend
          property: url
