# render.yaml
# This file configures the deployment of the AgentFM application on Render.
# It defines two services: the backend and the frontend.
#
# IMPORTANT:
# The PostgreSQL database is NOT defined here. You must create it manually
# in the Render dashboard. Follow these steps:
# 1. Go to your Render Dashboard -> New -> PostgreSQL.
# 2. After creation, copy the "Internal Connection String".
# 3. Go to the "agentfm-backend" service's Environment settings.
# 4. Add a new secret file or environment variable with the key DATABASE_URL
#    and paste the connection string as the value.

services:
  # ---------------------------------
  # Backend (Express + Prisma)
  # ---------------------------------
  - type: web
    name: agentfm-backend
    env: node
    rootDir: backend
    plan: free # Choose a plan that suits your needs.
    buildCommand: |
      npm install
      npx prisma generate
      npx prisma migrate deploy
    startCommand: node src/index.js
    autoDeploy: true
    healthCheck:
      path: /health
      initialDelaySeconds: 45
    envVars:
      # The DATABASE_URL must be set manually in the Render dashboard.
      - key: DATABASE_URL
        sync: false
      - key: JWT_SECRET
        generateValue: true
      - key: SESSION_SECRET
        generateValue: true
      - key: FRONTEND_URL
        fromService:
          type: static_site
          name: agentfm-frontend
          property: url
      - key: NODE_ENV
        value: production

  # ---------------------------------
  # Frontend (Vite static site)
  # ---------------------------------
  - type: static_site
    name: agentfm-frontend
    rootDir: frontend
    buildCommand: |
      npm install
      npm run build
    staticPublishPath: dist
    autoDeploy: true
    routes:
      - type: rewrite
        source: /api/*
        destination: https://agentfm-backend.onrender.com/api/*
      - type: rewrite
        source: /*
        destination: /index.html
    envVars:
      - key: VITE_API_BASE_URL
        fromService:
          type: web
          name: agentfm-backend
          property: url

