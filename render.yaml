# render.yaml
# This file configures the deployment of the AgentFM application on Render.
# It defines three services:
# 1. A PostgreSQL database for the backend.
# 2. The Express.js backend service.
# 3. The Vite/React frontend as a static site.

services:
  # ---------------------------------
  # PostgreSQL Database
  # ---------------------------------
  - type: psql
    name: agentfm-database
    plan: free # 'free' tier is suitable for development/hobby projects.

  # ---------------------------------
  # Backend (Express + Prisma)
  # ---------------------------------
  - type: web
    name: agentfm-backend
    env: node
    rootDir: backend
    plan: free # Choose a plan that suits your needs.
    buildCommand: |
      npm install
      npx prisma generate
      npx prisma migrate deploy
    startCommand: node src/index.js
    autoDeploy: true
    healthCheck:
      path: /health
      initialDelaySeconds: 45
    envVars:
      - key: DATABASE_URL
        fromService:
          type: psql
          name: agentfm-database
          property: connectionString
      - key: JWT_SECRET
        generateValue: true # Let Render generate a secure secret.
      - key: SESSION_SECRET
        generateValue: true # Let Render generate a secure secret.
      - key: FRONTEND_URL
        fromService:
          type: static_site
          name: agentfm-frontend
          property: url
      - key: NODE_ENV
        value: production

  # ---------------------------------
  # Frontend (Vite static site)
  # ---------------------------------
  - type: static_site
    name: agentfm-frontend
    rootDir: frontend
    buildCommand: |
      npm install
      npm run build
    staticPublishPath: dist
    autoDeploy: true
    routes:
      - type: rewrite
        source: /api/*
        destination: https://agentfm-backend.onrender.com/api/*
      - type: rewrite
        source: /*
        destination: /index.html
    envVars:
      - key: VITE_API_BASE_URL
        fromService:
          type: web
          name: agentfm-backend
          property: url
